---
title: "Wavelet Analysis"
author: "Jeffrey D Walker, PhD"
date: "August 15, 2014"
output:
  html_document:
    toc: yes
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Wavelet Analysis}
-->

This document describes the wavelet analysis of an annual precipitation timeseries. Two identical analyses are performed using 1) Scott Steinshneider's code and 2) the `biwavelet` package.

## Load Data

```{r load data, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
theme_set(theme_bw())
library(weatherGen)
data(climate)

# compute daily averages across sites
clim.da <- group_by(climate, DATE) %>%
  summarise(N=n(),
            PRCP=mean(PRCP),
            TMIN=mean(TMIN),
            TMAX=mean(TMAX))

# aggregate by water year
clim.wyr <- clim.da %>%
  mutate(WYEAR=ifelse(month(DATE)>=10, year(DATE)+1, year(DATE))) %>%
  group_by(WYEAR) %>%
  summarise(N=n(),
            PRCP=sum(PRCP),
            TMIN=mean(TMIN),
            TMAX=mean(TMAX))
```

Here is a timeseries plot of the annual precipitation timeseries.

```{r plot annual data, fig.cap="Annual Timeseries"}
ggplot(clim.wyr, aes(WYEAR, PRCP)) +
  geom_line() +
  labs(x="Water Year", y="Annual Precipitation (mm)")
```

## Wavelet Analysis

The goal of the wavelet analysis is to identify any significant low-frequency signals in the annual precipitation timeseries.

### Scott's Code

This section uses the code written by Scott Steinschneider. The names of the function and arguments have been modified, but the algorithm has not been changed.

The wavelet decomposition is performed using the `wavelet_annual()` function (formerly `WAVELET_ANALYSIS`). This function accepts a numeric array of the time series, a significance level, a type of background noise (white or red), and a flag for generating a plot of the result.

```{r annual wavelet}
wavelet_analysis <- wavelet_annual(x=clim.wyr$PRCP, sig=0.90, noise.type="white", plot.flag=TRUE)
```

The plots show a heat map of the localized power (W(s,t)) and the time-averaged global wavelet spectrum (GWS) as a function of Fourier period. The --o--o-- line shows `$period` vs. `$spectrum`, and the red ----- line shows `$period` vs. `$signif`. The "Significant Periods" are those where `$spectrum > $signif`.

```{r annual wavelet results}
wavelet_analysis
```

If we lower the significance level from 0.9 to 0.8 then the red line of significance shifts towards the y-axis. 

```{r annual wavelet with sig of 0.8}
wavelet_analysis2 <- wavelet_annual(x=clim.wyr$PRCP, sig=0.80, 
                                    noise.type="white", plot.flag=TRUE)
```

### biwavelet Package

The `biwavelet` package contains two functions (`biwavelet::wt()` and `biwavelet::wt.sig()`) that provide identical functionality as the `wavelet_annual` function. It turns out that this package is a translation of the [original matlab code](http://paos.colorado.edu/research/wavelets/software.html) accompanying Torrence and Compo (1998). This same matlab code was essentially used by Scott to create his own R version of the package.

Here is the same analysis for significance level of 0.90 and white background noise. 
```{r bw}
library(biwavelet)

bw <- biwavelet::wt(d=cbind(1:nrow(clim.wyr), clim.wyr$PRCP), dt=1, dj=1/4, 
                    max.scale=nrow(clim.wyr), sig.level=0.90, lag1=0, sig.test=1)
str(bw)
```

This function returns an object of class `biwavelet` that includes a generic plotting function.

```{r plot_bw}
plot(bw)
```

The time-averaged global wave spectrum (GWS) can be computed as the row-wise mean the `$power` matrix.

```{r bw gws}
bw$gws <- apply(bw$power, 1, mean)
```

The significance test of the GWS can be computed using the `biwavelet::wt.sig()` function. Note that the degrees of freedom is equal to the number of data points adjusted by scale (to account for edge effects).

```{r bw gws sig}
bw$gws.sig <- wt.sig(d=clim.wyr$PRCP, dt=bw$dt, scale=bw$scale, sig.test=1, 
                     sig.level=0.90, dof=nrow(clim.wyr)-bw$scale, 
                     mother='morlet', lag1=0.0)
```

The following tables show identical values for the period, global spectrum power, and significance between the `wavelet_annual()` and `biwavelet::wt()`output.

```{r wavelet bw compare}
# compare periods
cbind(biwavelet=bw$period, weatherGen=wavelet_analysis$period)

# compare global spectrum (row-wise mean of power for biwavelet::wt())
cbind(biwavelet=bw$gws, weatherGen=wavelet_analysis$spectrum)

# compare signif
cbind(biwavelet=bw$gws.sig$signif, weatherGen=wavelet_analysis$signif)
```

We can also plot the output of `biwavelet::wt()`

```{r bw output}
par(mfrow=c(1,2))
plot(bw, plot.cb=TRUE, plot.phase=FALSE)
plot(bw$gws, bw$period, type="b",
     xlab="Global Wavelet Spectrum", ylab="Fourier Period (Years)",
     log="y", ylim=rev(range(bw$period)), xlim=range(c(bw$gws, bw$gws.sig$signif)))
lines(bw$gws.sig$signif, bw$period, lty=2, col='red')  	
```

Which is identical to the `wavelet_analysis()` plot.

```{r wavelet analysis plot}
wavelet_analysis <- wavelet_annual(x=clim.wyr$PRCP, sig=0.90, noise.type='white', plot.flag=TRUE)
```

# Session Info

```{r session}
sessionInfo()
```

