---
title: "Wavelet Analysis"
author: "Jeffrey D Walker, PhD"
date: "August 15, 2014"
output:
  html_document:
    toc: yes
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Wavelet Analysis}
-->

## Load Data

```{r load libraries, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
theme_set(theme_bw())
library(weatherGen)
library(forecast)
```

```{r load data}
data(climate)

# compute daily averages across sites
clim.da <- group_by(climate, DATE) %>%
  summarise(N=n(),
            PRCP=mean(PRCP),
            TMIN=mean(TMIN),
            TMAX=mean(TMAX))

# aggregate by water year
clim.wyr <- clim.da %>%
  mutate(WYEAR=ifelse(month(DATE)>=10, year(DATE)+1, year(DATE))) %>%
  group_by(WYEAR) %>%
  summarise(N=n(),
            PRCP=sum(PRCP),
            TMIN=mean(TMIN),
            TMAX=mean(TMAX))
```

```{r plot annual data, fig.cap="Annual Timeseries"}
gather(clim.wyr, VAR, VALUE, PRCP:TMAX) %>%
  ggplot(aes(WYEAR, VALUE)) +
  geom_line() +
  facet_wrap(~VAR, scales='free_y', ncol=1)
```

## Annual Wavelet Analysis

```{r annual wavelet}
wavelet_analysis <- wavelet_annual(x=clim.wyr$PRCP, sig=0.90, noise.type="white", plot.flag=TRUE)
```

This plot shows a heat map of the wavelet analysis and summary of spectrum power (?) as a function of Fourier period. The --o--o-- line shows `$period` vs. `$spectrum`, and the red ----- line shows `$period` vs. `$signif`. The "Significant Periods" are those where `$spectrum > $signif`.

```{r annual wavelet results}
wavelet_analysis
```

If we lower the significance level from 0.9 to 0.8 then the red line of significance shifts towards the y-axis. 

```{r annual wavelet with sig of 0.8}
wavelet_analysis2 <- wavelet_annual(x=clim.wyr$PRCP, sig=0.80, 
                                    noise.type="white", plot.flag=TRUE)
```

### biwavelet Package

The `biwavelet` package and `biwavelet::wt()` function provide similar functionality as the `wavelet_annual` function. The following shows the same output generated by each. 

And here is the output using the same `dof <- 2` as the `biwavelet::wt.sig()` function.
```{r compare wavelet}
sig.level <- 0.90
lag1 <- 0.0
noise.type <- "white"

wavelet_analysis <- wavelet_annual(x=clim.wyr$PRCP, sig=sig.level, noise.type=noise.type, plot.flag=FALSE)
```

And here is the same computation using `biwavelet::wt()`.
```{r bw}
library(biwavelet)

bw <- biwavelet::wt(d=cbind(1:nrow(clim.wyr), clim.wyr$PRCP), dt=1, dj=1/4, 
                    max.scale=nrow(clim.wyr)*1, sig.level=sig.level, lag1=lag1, sig.test=1)
bw$gws <- apply(bw$power, 1, mean)

# signif of global wave spectrum
bw$gws.sig <- wt.sig(d=clim.wyr$PRCP,
       dt=bw$dt, scale=bw$scale, sig.test=1, sig.level=sig.level, dof=nrow(clim.wyr)-bw$scale, 
       mother='morlet', lag1=lag1)
# bw.gws.sig <- wavelet_signif(d=clim.wyr$PRCP,
#        dt=bw$dt, scale=bw$scale, sig.test=1, sig.level=0.90, dof=nrow(clim.wyr)-bw$scale, 
#        mother='morlet', lag1=0.72)

str(bw)
```

The following tables show identical values for the period, global spectrum power, and significance between the `wavelet_annual()` and `biwavelet::wt()`output.

```{r wavelet bw compare}
# compare periods
cbind(biwavelet=bw$period, weatherGen=wavelet_analysis$period)

# compare global spectrum (row-wise mean of power for biwavelet::wt())
cbind(biwavelet=bw$gws, weatherGen=wavelet_analysis$spectrum)

# compare signif
cbind(biwavelet=bw$gws.sig$signif, weatherGen=wavelet_analysis$signif)
```

We can also plot the output of `biwavelet::wt()`

```{r bw output}
par(mfrow=c(1,2))
plot(bw, plot.cb=TRUE, plot.phase=FALSE)
plot(bw$gws, bw$period, type="b",
     xlab="Global Wavelet Spectrum", ylab="Fourier Period (Years)",
     log="y", ylim=rev(range(bw$period)), xlim=range(c(bw$gws, bw$gws.sig$signif)))
lines(bw$gws.sig$signif, bw$period, lty=2, col='red')  	
```

Which is identical to the `wavelet_analysis()` plot.

```{r wavelet analysis plot}
wavelet_analysis <- wavelet_annual(x=clim.wyr$PRCP, sig=sig.level, noise.type=noise.type, plot.flag=TRUE)
```

# Appendix

```{r session}
sessionInfo()
```

