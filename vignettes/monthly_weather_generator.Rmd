---
title: "Monthly Weather Generator"
author: "Jeffrey D Walker, PhD"
date: "August 21, 2014"
output:
  html_document:
    toc: yes
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Monthly Weather Generator}
-->

# Load Libraries

```{r libraries, warning=FALSE, message=FALSE}
library(forecast)
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(ggplot2)
theme_set(theme_bw())
library(weatherGen)
data(climate)

# set RNG seed for reproducibility
set.seed(2345)
```

# Load Monthly Climate Data

This analysis will use the [gridded climate dataset by Maurer et al, 2002](http://www.engr.scu.edu/~emaurer/gridded_obs/index_gridded_obs.html). The data have already been downloaded and converted to an SQLite database using the makefile in [walkerjeffd/climate-data/maurer](https://github.com/walkerjeffd/climate-data/tree/master/maurer). After following the instructions in this repo, there should be an SQLite database called `maurer/db/maurer_mon.db`, which contains a `grid` table containing the grid points, and a `data` table containing the monthly timeseries for each grid point. See the [vignette](https://github.com/walkerjeffd/climate-data/blob/master/maurer/vignette/maurer-mon.Rmd) for examples on how to use this database.

```{r db grid}
DB_PATH <- '/Users/jeff/Projects/UMass/climate-data/maurer/db/maurer_mon.db'
db <- src_sqlite(DB_PATH, create = FALSE)

df.grid <- tbl(db, "grid") %>%
  collect
```

Here is a map of the climate data grid points.

```{r map east, warning=FALSE}
library(ggmap)
map <- get_map(location=c(lon=mean(range(df.grid$LON)), lat=mean(range(df.grid$LAT))),
               zoom=4, maptype="satellite", color='bw')
ggmap(map, darken=c(0.25, "white"), extent="device") +
  geom_point(aes(x=LON, y=LAT), data=df.grid, color='red', size=1)
```

Zoomed into new england. The green points will be used to compute a regional average.

```{r map new england, warning=FALSE}
map <- get_map(location=c(lon=-72, lat=42),
               zoom=7, maptype="satellite", color='bw')
ggmap(map, darken=c(0.25, "white"), extent="device") +
  geom_point(aes(x=LON, y=LAT, color=SELECT), 
             data=mutate(df.grid, SELECT=(LAT>=41 & LAT<=43 & LON>=-74 & LON<=-70)), size=2) +
  geom_vline(aes(xintercept=LON), color='green', linetype=2, 
             data=data.frame(LON=seq(-74, -70))) +
  geom_hline(aes(yintercept=LAT), color='green', linetype=2, 
             data=data.frame(LAT=seq(41, 43))) +
  scale_color_manual(values=c("TRUE"="green", "FALSE"="red"), guide=FALSE)
```

## Monthly Climate Dataset

Using the selected grid points, retrieve the monthly timeseries from the database. Also, compute the variable `TAVG` as the arithmetic mean of `TMIN` and `TMAX`.

```{r climate load}
clim.mon <- tbl(db, "data") %>%
  filter(LAT>=41, LAT<=43, LON>=-74, LON<=-70) %>%
  collect %>%
  select(-REGION, -WIND) %>%
  mutate(TAVG=(TMIN+TMAX)/2) %>%
  gather(VAR, VALUE, PRCP, TMIN, TMAX, TAVG)
summary(clim.mon)
```

Compute annual timeseries of each climate variable and each location. Note that precipitation is simply the annual sum, while the other three variables are computed as weighted means based on the number of days in each month to get a correct annual mean.

```{r climate yr}
clim.yr <- spread(clim.mon, VAR, VALUE) %>%
  mutate(MONTHYEAR=ymd(paste(YEAR,MONTH,1,sep='-')),
         N_DAY=days_in_month(MONTHYEAR)) %>%
  group_by(LAT, LON, YEAR) %>%
  summarise(PRCP=sum(PRCP),
            TMAX=sum(TMAX*N_DAY)/sum(N_DAY),
            TMIN=sum(TMIN*N_DAY)/sum(N_DAY),
            TAVG=sum(TAVG*N_DAY)/sum(N_DAY)) %>%
  gather(VAR, VALUE, PRCP:TAVG)
summary(clim.yr)
```


## Regional Average

Compute the regional average monthly value of each climate variable.

```{r climate reg mon}
clim.reg.mon <- clim.mon %>%
  group_by(YEAR, MONTH, VAR) %>%
  summarise(MEAN=mean(VALUE),
            SD=sd(VALUE))
summary(clim.reg.mon)
```

This figure shows the regional average monthly climate timeseries. The shaded region shows mean +/- 1 standard deviation.

```{r plot clim reg mon}
mutate(clim.reg.mon, DATE=ymd(paste(YEAR,MONTH,1,sep='-'))) %>%
  ggplot(aes(DATE, MEAN)) +
  geom_ribbon(aes(ymin=MEAN-SD, ymax=MEAN+SD), fill='grey50') +
  geom_line(color='blue') +
  facet_wrap(~VAR, ncol=1, scales='free_y') +
  labs(x="Month/Year", y="Mean +/- StDev")
```

Compute the regional average annual value of each climate variable.

```{r climate reg yr}
clim.reg.yr <-  clim.yr %>%
  group_by(VAR, YEAR) %>%
  summarise(MEAN=mean(VALUE),
            SD=sd(VALUE))
summary(clim.reg.yr)
```

This figure shows the regional-average annual climate timeseries. The shaded region shows the mean +/- 1 standard deviation.

```{r plot clim reg yr}
ggplot(clim.reg.yr, aes(YEAR, MEAN)) +
  geom_ribbon(aes(ymin=MEAN-SD, ymax=MEAN+SD), fill='grey80') +
  geom_line(color='blue') +
  facet_wrap(~VAR, ncol=1, scales='free_y') +
  labs(x="Year", y="Mean +/- StDev")
```

Convert the regional average datasets wide format for use in the weather generator.

```{r clim reg wide}
clim.reg.mon <- select(clim.reg.mon, -SD) %>%
  spread(VAR, MEAN)
head(clim.reg.mon)

clim.reg.yr <- select(clim.reg.yr, -SD) %>%
  spread(VAR, MEAN)
head(clim.reg.yr)
```

# Wavelet Analysis

Perform wavelet analysis on regional average annual precipitation timeseries.

```{r plot wave, message=FALSE, warning=FALSE}
wt.reg <- wavelet_analysis(clim.reg.yr$PRCP, sig.level=0.90, noise.type='white')

par(mfrow=c(1,2))
plot(wt.reg, plot.cb=TRUE, plot.phase=FALSE)
plot(wt.reg$gws, wt.reg$period, type="b",
     xlab="Global Wavelet Spectrum", ylab="",
     log="y", ylim=rev(range(wt.reg$period)), 
     xlim=range(c(wt.reg$gws, wt.reg$gws.sig$signif)))
lines(wt.reg$gws.sig$signif, wt.reg$period, lty=2, col='red')
```

Although there are some significant wavelet periods, we'll use a simple arima model of the regional annual precipitation instead of arima models of the wavelet components.

```{r arima model}
models <- list(PRCP=auto.arima(clim.reg.yr$PRCP,
                               max.p=2,max.q=2,max.P=0,max.Q=0,
                               stationary=TRUE))
models[["PRCP"]]
```

This figure shows a 20-year forecast of the arima model reflecting no low-frequency oscillations (since we are not using the wavelet decomposition).

```{r plot arima forecast}
par(mfrow=c(1,1))
plot(forecast(models[['PRCP']], h=20), main="ARIMA Forecast of Regional Annual Precip",
     xlab="Timestep (yr)", ylab='Annual Precip (mm/yr)')
```

Generate 50 simulations of annual precipitation using the AR1 model of the regional annual precipitation.

```{r mc ar, warning=FALSE}
sim.prcp <- weatherGen::mc_arimas(models=models, n=nrow(clim.reg.yr), n.iter=50)
str(sim.prcp)
```

Compare the GWS power and the mean, standard deviation, and skewness statistics across these simulations (red point is the overall mean, boxplots are the distribution across simulations) to regional annual precipitation timeseries (blue point).  

```{r plot gws stats, fig.height=8}
par(mfrow=c(2,2))
x1 <- 1
x2 <- min(length(wt.reg$period), nrow(sim.prcp$gws))
ymin <- min(wt.reg$period[x1:x2], wt.reg$gws[x1:x2],
            sim.prcp$gws.stat[x1:x2, 'MEAN'],
            sim.prcp$gws.stat[x1:x2, 'Q025'])
ymax <- max(wt.reg$period[x1:x2], wt.reg$gws[x1:x2],
            sim.prcp$gws.stat[x1:x2, 'MEAN'],
            sim.prcp$gws.stat[x1:x2, 'Q975'])
plot(wt.reg$period[x1:x2], wt.reg$gws[x1:x2],
     type="n", ylim=c(ymin,ymax), xlab="Period (years)", ylab="",
     main="", log="y")
mtext(side=2, expression(paste("Power (",mm^2,")")), line=2.5)
polygon(c(wt.reg$period[x1:x2],
          rev(wt.reg$period[x1:x2])),
        c(sim.prcp$gws.stat[x1:x2, 'Q025'],
          rev(sim.prcp$gws.stat[x1:x2, 'Q975'])),
        col="grey")
lines(wt.reg$period[x1:x2], wt.reg$gws[x1:x2])
lines(wt.reg$period[x1:x2], sim.prcp$gws.stat[x1:x2, 'MEAN'], lty=2, col="blue")
lines(wt.reg$period[x1:x2], wt.reg$gws.sig$signif[x1:x2], col="red", lty=3)

boxplot(colMeans(sim.prcp$x), main="Mean")
points(mean(clim.reg.yr$PRCP),col="red",pch=19)
points(mean(colMeans(sim.prcp$x)), col="blue", pch=19)

boxplot(apply(sim.prcp$x, 2, sd), main="Standard Deviation")
points(sd(clim.reg.yr$PRCP), col="red", pch=19)
points(mean(apply(sim.prcp$x, 2, sd)), col="blue", pch=19)

boxplot(apply(sim.prcp$x, 2, skewness), main="Skew")
points(skewness(clim.reg.yr$PRCP), col="red", pch=19)
points(mean(apply(sim.prcp$x, 2, skewness)),col="blue",pch=19)
```

This figure shows the simulated and observed regional-average annual precipitation. The simulations were generated using the AR1 model described above.

```{r plot ar sims}
as.data.frame(sim.prcp$x) %>%
  mutate(TIMESTEP=row_number()) %>% 
  gather(TRIAL, VALUE, -TIMESTEP) %>% 
  ggplot(aes(TIMESTEP, VALUE)) + 
  geom_line(aes(group=TRIAL), alpha=0.3) + 
  stat_summary(fun.y=mean, geom='line', color='red', size=1) +
  geom_line(aes(x=TIMESTEP, y=PRCP), data=mutate(clim.reg.yr, TIMESTEP=row_number()), color='blue', size=1) +
  labs(x="Year", y="Annual Precipitation (mm/yr)", 
       title="WARM Annual Precipitation Simulations\nRed Line=Mean of Simulations, Blue Line=Observd Regional Mean")
```

# Monthly Weather Generator

## Select Location

First, select a random location from the complete climate dataset.

```{r select loc}
clim.locs <- select(clim.yr, LAT, LON) %>%
  unique()
loc <- clim.locs[sample(nrow(clim.locs), size=1),] %>% as.numeric
names(loc) <- c('LAT', 'LON')
loc
```

Now extract the monthly and annual climate datasets for this location.

```{r loc datasets}
clim.loc.yr <- filter(clim.yr, LAT==loc[['LAT']], LON==loc[['LON']]) %>%
  spread(VAR, VALUE) %>%
  arrange(YEAR)
clim.loc.mon <- filter(clim.mon, LAT==loc[['LAT']], LON==loc[['LON']]) %>%
  spread(VAR, VALUE) %>%
  arrange(YEAR, MONTH)
```

## Nearest Neighbors

Compute the euclidian distance between a single simulated annual precipitation value and each observed year. The simulated annual precipitation is for the first year in the first simulation trial.

```{r distances}
j <- 1 # year number
samp <- 1 # simulation trial number

# compute distances between simulated WARM timeseries and observed regional precip
distances <- cbind(clim.reg.yr, DISTANCE=sqrt((sim.prcp$x[j,samp] - clim.reg.yr$PRCP)^2))

ggplot(distances, aes(YEAR, PRCP)) + 
  geom_line() +
  geom_point(aes(color=DISTANCE), size=3) +
  geom_hline(yint=sim.prcp$x[j,samp], linetype=2, color='red') +
  geom_text(x=max(distances$YEAR), y=sim.prcp$x[j,samp], label="Sim", hjust=1, vjust=-0.5) +
  scale_color_gradient(low='green', high='red') +
  labs(x="Year", y="Annual Precipitation (mm/yr)", 
       title="Regional and Current Simulation Annual Precipitation")
```

Select the eight years from the observed regional annual simulation that are the most similar to the first simulation trial and year.

```{r plot top distances}
distances <- mutate(distances,
                    IN_TOP_8=rank(DISTANCE) %in% seq(1,8))
distances %>%
  ggplot(aes(YEAR, PRCP)) + 
  geom_line() +
  geom_point(aes(color=DISTANCE), size=3) +
  geom_hline(yint=sim.prcp$x[j,samp], linetype=2, color='red') +
  geom_point(mapping=aes(alpha=IN_TOP_8), color='black', shape=1, size=4) +
  geom_text(aes(x=YEAR, y=PRCP, label=YEAR), data=filter(distances, IN_TOP_8), vjust=-1) +
  geom_text(x=max(distances$YEAR), y=sim.prcp$x[j,samp], label="Sim", hjust=1, vjust=-0.5) +
  scale_alpha_manual(values=c("TRUE"=1, "FALSE"=0), guide=FALSE) +
  scale_color_gradient(low='green', high='red') +
  labs(x="Year", y="Annual Precipitation (mm)", title="Regional Annual Precipitation with 8 Nearest Neighbors Selected")
```

Extract the observed regional precipitation for the candidate years and compute the sampling weights as inverse distance-squared weighted.

```{r top distances}
distances.top <- filter(distances, IN_TOP_8) %>%
  mutate(WEIGHT=(1/DISTANCE)^2,
         WEIGHT=WEIGHT/sum(WEIGHT))
distances.top %>%
  ggplot(aes(PRCP, WEIGHT)) +
  geom_point() +
  geom_vline(xint=sim.prcp$x[j,samp], linetype=2, color='red') +
  geom_text(aes(label=YEAR), hjust=-0.1) +
  geom_text(x=sim.prcp$x[j,samp], y=0.4, label="Sim Precip", hjust=-0.1) +
  labs(x="Annual Precipitation (mm)", y="Sample Weight")
```

Now we can randomly sample from the 8 nearest neighbors using the sampling weights based on the inverse distance squared. We'll do this 1000 times and compare the frequency of the samples to the sample weights.

```{r sample years}
sampled.years <- sample(distances.top$YEAR,
                        size=1000,
                        prob=distances.top$WEIGHT,
                        replace=TRUE)
sampled.years.tbl <- prop.table(table(sampled.years))
merge(distances.top, 
      data.frame(YEAR=names(sampled.years.tbl),
                 FREQ=as.vector(sampled.years.tbl)),
      all.x=TRUE) %>%
  select(YEAR, WEIGHT, FREQ) %>%
  ggplot(aes(WEIGHT, FREQ)) +
  geom_point(size=3) +
  geom_abline(linetype=2) +
  labs(x="Sample Weight", y="Sampled Frequency")
```

Now if we just sample for one year.

```{r sample year}
sampled.year <- sample(distances.top$YEAR, size=1, prob=distances.top$WEIGHT, replace=TRUE)
sampled.year
```

Then we can extract the observed monthly climate data for the sampled year from the observed dataset of the selected location.

```{r sampled monthly climate}
filter(clim.loc.mon, YEAR==sampled.year)
```

## Generate Complete Timeseries

Given the selected location, repeat the nearest neighbor process for each of the `num_sim` simulations and `num_year` years, and store the result in a 3-dimensional array.

```{r gen set up}
num_sim <- ncol(sim.prcp$x)
num_year <- nrow(sim.prcp$x) # number of composited years
num_months <- num_year*12

climate_variables <- select(clim.reg.yr, -YEAR) %>%
  names()

sampled.year <- array(NA, c(num_year, num_sim))
gen.loc.mon.arr <- array(NA, c(num_months, length(climate_variables), num_sim))
```

```{r gen loop}
# loop through simulations (trials)
for (samp in 1:num_sim) {
    # loop through years
    for (j in 1:num_year) {
        # compute distances between simulated WARM timeseries and observed regional precip
      distances <- mutate(clim.reg.yr, 
                          DISTANCE=sqrt((sim.prcp$x[j, samp] - clim.reg.yr$PRCP)^2),
                          IN_TOP_8=rank(DISTANCE) %in% seq(1,8))
      distances.top <- filter(distances, IN_TOP_8) %>%
                       mutate(WEIGHT=(1/DISTANCE)^2,
                              WEIGHT=WEIGHT/sum(WEIGHT))
      sampled.year[j,samp] <- sample(distances.top$YEAR,
                                     size=1,
                                     prob=distances.top$WEIGHT,
                                     replace=FALSE)
      row.idx <- ((1+12*(j-1)):(12+12*(j-1)))
      gen.loc.mon.arr[row.idx, , samp] <- data.matrix(filter(clim.loc.mon, 
                                                             YEAR==sampled.year[j, samp]) %>%
                                                      select(PRCP, TMAX, TMIN, TAVG))
    }
}
```

Now convert the 3-dim array to a list of dataframes with each element in the list containing the simulated data for a single variable.

```{r gen loc mon}
gen.loc.mon <- sapply(climate_variables, function(v) {
  i.var <- which(climate_variables==v)
  df <- as.data.frame(gen.loc.mon.arr[,i.var,]) %>%
    mutate(TIMESTEP=row_number(),
           SIM_YEAR=rep(seq(1, num_year), each=12),
           SIM_MONTH=rep(seq(1, 12), times=num_year),
           VAR=v) %>%
    gather(TRIAL, VALUE, -TIMESTEP, -SIM_YEAR, -SIM_MONTH, -VAR) %>%
    mutate(TRIAL=as.numeric(TRIAL))
  return(list(df))
})
str(gen.loc.mon)
```

Aggregate the generated timeseries to compute annual values or each variable.

```{r gen loc yr}
gen.loc.yr <- lapply(gen.loc.mon, function(df) {
  if ('PRCP' %in% unique(df$VAR)) {
    df.yr <- group_by(df, VAR, TRIAL, SIM_YEAR) %>%
      summarise(VALUE=sum(VALUE))
  } else {
    df.yr <- group_by(df, VAR, TRIAL, SIM_YEAR) %>%
      summarise(VALUE=mean(VALUE))
  }
  df.yr <- df.yr %>%
    ungroup() %>%
    as.data.frame()
  return(df.yr)
})
str(gen.loc.yr)
```

This figure shows all the weather generator simulations compared to the observed climate dataset at the selected location.

```{r plot gen loc yr}
do.call(rbind, gen.loc.yr) %>%
  mutate(VAR=factor(VAR)) %>%
  ggplot() +
    geom_line(aes(SIM_YEAR, VALUE, group=TRIAL), alpha=0.5) +
    geom_line(aes(SIM_YEAR, VALUE), 
              data=mutate(clim.reg.yr, SIM_YEAR=row_number()) %>%
                gather(VAR, VALUE, PRCP:TAVG), 
              color='red') +
    facet_wrap(~VAR, scales='free_y') +
    labs(x="Simulation Year", y="Value", title="All Generated Datasets with Observed Location Dataset ")
```

This figure shows only the first weather generator simulation compared to the observed climate dataset at the selected location.

```{r plot gen loc yr one}
do.call(rbind, gen.loc.yr) %>%
  mutate(VAR=factor(VAR)) %>%
  filter(TRIAL==1) %>%
  ggplot() +
    geom_line(aes(SIM_YEAR, VALUE, group=TRIAL), alpha=0.5) +
    geom_line(aes(SIM_YEAR, VALUE), 
              data=mutate(clim.reg.yr, SIM_YEAR=row_number()) %>%
                gather(VAR, VALUE, PRCP:TAVG), 
              color='red') +
    facet_wrap(~VAR, scales='free_y') +
    labs(x="Simulation Year", y="Value", title="Single Generated Dataset with Observed Location Dataset ")
```

The following three figures compare the mean, standard deviation, and skewness of the annual precipitation timeseries between the weather generator simulations and the observed climate dataset at the selected location. The boxplots show the distribution of each statistic across the simulations, the red point shows the mean of the statistic for the simulations, and the blue point shows the statistic value for the observed annual timeseries.

```{r plot gen loc yr box mean, fig.width=4}
do.call(rbind, gen.loc.yr) %>%
  mutate(VAR=factor(VAR)) %>%
  group_by(VAR, TRIAL) %>%
  summarise(MEAN=mean(VALUE)) %>%
  ggplot(aes(x=1, y=MEAN)) +
    geom_boxplot() +
    stat_summary(fun.y=mean, geom="point", color="red", size=3) +
    geom_point(aes(x=1, y=MEAN), 
               data=gather(clim.loc.yr, VAR, VALUE, PRCP:TAVG) %>% 
                      group_by(VAR) %>% 
                      summarise(MEAN=mean(VALUE)),
               color='blue', size=3) +
    facet_wrap(~VAR, scales='free_y') +
    labs(x="", y="Mean", title="Mean of Annual Precipitation for Generated (Red) and Observed (Blue)") +
    theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```

```{r plot gen loc yr box sd, fig.width=4}
do.call(rbind, gen.loc.yr) %>%
  mutate(VAR=factor(VAR)) %>%
  group_by(VAR, TRIAL) %>%
  summarise(SD=sd(VALUE)) %>%
  ggplot(aes(x=1, y=SD)) +
    geom_boxplot() +
    stat_summary(fun.y=mean, geom="point", color="red", size=3) +
    geom_point(aes(x=1, y=SD), 
               data=gather(clim.loc.yr, VAR, VALUE, PRCP:TAVG) %>% 
                      group_by(VAR) %>% 
                      summarise(SD=sd(VALUE)),
               color='blue', size=3) +
    facet_wrap(~VAR, scales='free_y') +
    labs(x="", y="Standard Deviation", title="StDev of Annual Precipitation for Generated (Red) and Observed (Blue)") +
    theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```

```{r plot gen loc yr box skew, fig.width=4}
do.call(rbind, gen.loc.yr) %>%
  mutate(VAR=factor(VAR)) %>%
  group_by(VAR, TRIAL) %>%
  summarise(SKEW=skewness(VALUE)) %>%
  ggplot(aes(x=1, y=SKEW)) +
    geom_boxplot() +
    stat_summary(fun.y=mean, geom="point", color="red", size=3) +
    geom_point(aes(x=1, y=SKEW), 
               data=gather(clim.loc.yr, VAR, VALUE, PRCP:TAVG) %>% 
                      group_by(VAR) %>% 
                      summarise(SKEW=skewness(VALUE)),
               color='blue', size=3) +
    facet_wrap(~VAR, scales='free_y') +
    labs(x="", y="Skewness", title="Skewness of Annual Precipitation for Generated (Red) and Observed (Blue)") +
    theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
```

# Climate Change Trends

Linear trends are incorporated in the generated timeseries using an additive temperature factor and a multiplicative precipitation factor. 

```{r compute trends}
trend.prcp <- 1.5 # multiplicative trend factor
trend.temp <- 2   # additive trend factor

# select one trial at random
sim.trial <- sample(dim(gen.loc.mon.arr)[3], 1)     

sim.clim <- data.frame(YEAR=clim.reg.mon$YEAR,
                       MONTH=clim.reg.mon$MONTH,
                       TRIAL=sim.trial,
                       TREND.TEMP=trend.temp,
                       TREND.PRCP=trend.prcp,
                       PRCP.GEN=gen.loc.mon.arr[, 1, sim.trial],
                       TMAX.GEN=gen.loc.mon.arr[, 2, sim.trial],
                       TMIN.GEN=gen.loc.mon.arr[, 3, sim.trial],
                       TAVG.GEN=gen.loc.mon.arr[, 4, sim.trial]) %>%
  # compute trend timeseries
  mutate(PRCP.TREND=PRCP.GEN * seq(1, trend.prcp, length.out=length(PRCP.GEN)),
         TMAX.TREND=TMAX.GEN + seq(0, trend.temp, length.out=length(TMAX.GEN)),
         TMIN.TREND=TMIN.GEN + seq(0, trend.temp, length.out=length(TMIN.GEN)),
         TAVG.TREND=TAVG.GEN + seq(0, trend.temp, length.out=length(TAVG.GEN)))
```

This figure compares the original generate timeseries to the adjusted timeseries for the given trend factors.

```{r clim gen trend, fig.height=8}
sim.clim %>%
  gather(VAR.GROUP, VALUE, PRCP.GEN:TAVG.TREND) %>%
  separate(VAR.GROUP, c("VAR", "GROUP")) %>%
  mutate(DATE=ymd(paste(YEAR, MONTH, 1, sep='-'))) %>%
  ggplot(aes(DATE, VALUE, color=GROUP)) +
  geom_line() +
  facet_wrap(~VAR, ncol=1, scales='free_y') +
  labs(x="Month/Year", y="") +
  scale_color_manual('', values=c(GEN='grey20', TREND='chartreuse3'),
                     labels=c(GEN='w/o trend', TREND='w/ trend'))
```

This figure shows the original climate timeseries for the regional-average dataset and the selected location.

```{r clim loc reg, fig.height=8}
clim.loc.mon %>%
  select(-LAT, -LON) %>%
  mutate(SOURCE="Location") %>%
  rbind(clim.reg.mon %>% mutate(SOURCE="Region")) %>%
  mutate(SOURCE=factor(SOURCE)) %>%
  gather(VAR, VALUE, PRCP:TAVG) %>%
  mutate(DATE=ymd(paste(YEAR, MONTH, 1, sep='-'))) %>%
  ggplot(aes(DATE, VALUE, color=SOURCE)) +
  geom_line() +
  labs(x="Month/Year", y="") +
  scale_color_manual('', values=c('steelblue', 'orangered')) +
  facet_wrap(~VAR, ncol=1, scales='free_y')
```

## Stress Test Trends

```{r}
trend.factors <- expand.grid(PRCP=seq(0.75, 1.25, by=0.05),
                             TEMP=seq(0, 5, by=0.5))
```

# Session Info

```{r session}
sessionInfo()
```


