---
title: "Daily Weather Generator for a Single Site"
author: "Jeffrey D Walker, PhD"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

This document shows how to use the daily weather generator for a single site.

```{r libraries, echo=FALSE, message=FALSE}
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(moments)
library(weathergen)
theme_set(theme_bw())

# initial month of the water year
start_month <- 10
```

# Load Historical Data

First, load the historical daily climate data for Boston, MA from the `climate_cities` dataset included in `weathergen`.

```{r load-obs}
data(climate_cities)
obs_day <- climate_cities[['boston']]

# subset complete water years
obs_day <- obs_day[complete_water_years(obs_day$DATE),]

obs_day <- mutate(obs_day,
                  WYEAR=wyear(DATE, start_month=start_month),
                  MONTH=month(DATE),
                  TEMP=(TMIN+TMAX)/2) %>%
  select(WYEAR, MONTH, DATE, PRCP, TEMP, TMIN, TMAX, WIND)

# compute annual timeseries by water year
obs_wyr <- group_by(obs_day, WYEAR) %>%
  summarise(PRCP=sum(PRCP),
            TEMP=mean(TEMP),
            TMIN=mean(TMIN),
            TMAX=mean(TMAX),
            WIND=mean(WIND))

obs <- list(day=obs_day, wyr=obs_wyr)

summary(obs[['day']])
```

This figure shows daily timeseries of each climate variable for Boston, MA.

```{r plot-obs-da, fig.height=8, fig.width=6, echo=FALSE}
gather(obs[['day']], VAR, VALUE, PRCP:WIND) %>%
  ggplot(aes(DATE, VALUE)) +
  geom_line() +
  facet_wrap(~VAR, scales='free_y', ncol=1) +
  labs(x='', y='', title='Historical Daily Weather Data for Boston, MA')
```

This figure shows the annual sum of precipitation, and means of minimum temperature, maximum temperature, and wind speed by water year. 

```{r plot-obs-wyr, fig.height=8, fig.width=6, echo=FALSE}
gather(obs[['wyr']], VAR, VALUE, PRCP:WIND) %>%
  ggplot(aes(WYEAR, VALUE)) +
    geom_line() +
    facet_wrap(~VAR, scales='free_y', ncol=1) +
    labs(x='', y='', title='Historical Annual Weather Data for Boston, MA')
```

# Daily Weather Generator

The daily weather generator is `wgen_daily()`.

```{r}
sim_da <- wgen_daily(obs_day = zoo(x = obs[['day']][, c('PRCP', 'TEMP', 'TMIN', 'TMAX', 'WIND')], 
                               order.by = obs[['day']][['DATE']]), 
                     n_year=1, n_knn_annual=100,
                     dry_wet_threshold=0.3, wet_extreme_quantile_threshold=0.8,
                     start_month=10, start_water_year=2000, include_leap_days=FALSE,
                     adjust_annual_precip=TRUE, annual_precip_adjust_limits=c(0.9, 1.1),
                     dry_spell_changes=1, wet_spell_changes=1,
                     prcp_mean_changes=1, prcp_cv_changes=1, temp_changes=0)
```

```{r}
library(parallel)
sim_da_batch <- mclapply(seq(1, 20), function(i) {
  wgen_daily(obs_day = zoo(x = obs[['day']][, c('PRCP', 'TEMP', 'TMIN', 'TMAX', 'WIND')], 
                               order.by = obs[['day']][['DATE']]), 
                     n_year=10, n_knn_annual=100,
                     dry_wet_threshold=0.3, wet_extreme_quantile_threshold=0.8,
                     start_month=10, start_water_year=2000, include_leap_days=FALSE,
                     adjust_annual_precip=TRUE, annual_precip_adjust_limits=c(0.9, 1.1),
                     dry_spell_changes=1, wet_spell_changes=1,
                     prcp_mean_changes=1, prcp_cv_changes=1, temp_changes=0)
}, mc.cores=6)
```

```{r}
sim_arr <- array(NA_real_, dim=c(20, 3650, 4))

for (i in 1:20) {
  sim_arr[i,,] <- as.matrix(sim_da_batch[[i]][['out']][, c('PRCP', 'TEMP', 'TMIN', 'TMAX')])  
}

apply(sim_arr, 3, mean)
```


```{r}
sim_da_batch_prcp_mean <- mclapply(seq(0, 100), function(i) {
  wgen_daily(obs_day = zoo(x = obs[['day']][, c('PRCP', 'TEMP', 'TMIN', 'TMAX', 'WIND')], 
                               order.by = obs[['day']][['DATE']]), 
                     n_year=10, n_knn_annual=100,
                     dry_wet_threshold=0.3, wet_extreme_quantile_threshold=0.8,
                     start_month=10, start_water_year=2000, include_leap_days=FALSE,
                     adjust_annual_precip=TRUE, annual_precip_adjust_limits=c(0.9, 1.1),
                     dry_spell_changes=1, wet_spell_changes=1,
                     prcp_mean_changes=1+(i-50)/100, prcp_cv_changes=1, temp_changes=0)
}, mc.cores=6)

sim_da_batch_dry_spell <- lapply(seq(0, 100), function(i) {
  wgen_daily(obs_day = zoo(x = obs[['day']][, c('PRCP', 'TEMP', 'TMIN', 'TMAX', 'WIND')], 
                               order.by = obs[['day']][['DATE']]), 
                     n_year=10, n_knn_annual=100,
                     dry_wet_threshold=0.3, wet_extreme_quantile_threshold=0.8,
                     start_month=10, start_water_year=2000, include_leap_days=FALSE,
                     adjust_annual_precip=TRUE, annual_precip_adjust_limits=c(0.9, 1.1),
                     dry_spell_changes=1+(i-50)/200, wet_spell_changes=1,
                     prcp_mean_changes=1, prcp_cv_changes=1, temp_changes=0)
}, mc.cores=6)
```




# Historical Simulation

In this section, a daily simulation is performed without any adjustment to the statistics or behavior of the weather variables.

## Simulation Parameters

The following parameters define the simulation.

```{r}
start_water_year <- 2000 # starting water year for simulation
n_year <- 40             # number of simulation years
n_knn_annual <- 100      # population size for annual KNN sampling (default)

# change factors
dry_spell_changes <- 1   # change factor for dry spell (0.8 - 1.2?)
wet_spell_changes <- 1   # change factor for wet spell (0.8 - 1.2?)
prcp_mean_changes <- 1   # change factor for mean precipitation (0.8 - 1.2?)
prcp_cv_changes <- 1     # change factor for precipitation coef. of variation (0.8 - 1.2?)
temp_changes <- 0        # additive factor for temperature variables (-10 - 10)
```

## Annual Precipitation Simulation

A sequence of annual precipitation values are simulated using the `sim_annual_arima()` function. This function first fits an ARIMA model to the historical annual precipitation. The ARIMA model is then used to generate a simulation of annual precipitation for length `n_year`. The `wgen_annual_arima()` function returns a list of length 3 containing the ARIMA model object (`model`), the historical annual precipitation (`observed`), and the simulated annual precipitation (`values`). 

```{r sim-annual}
sim_annual_prcp <- sim_annual_arima(x = obs[['wyr']][['PRCP']], start_year = start_water_year, n_year = n_year)
str(sim_annual_prcp, max.level=1)
```

```{r plot-sim-annual}
data.frame(WYEAR=time(sim_annual_prcp[['out']]),
           PRCP=zoo::coredata(sim_annual_prcp[['out']])) %>%
  ggplot(aes(WYEAR, PRCP)) +
  geom_line() +
  geom_hline(yint=mean(obs[['wyr']][['PRCP']]), color='red') +
  geom_text(aes(label=TEXT), data=data.frame(WYEAR=2000, PRCP=mean(obs[['wyr']][['PRCP']]), TEXT="Historical Mean"),
            hjust=0, vjust=-1, color='red') +
  labs(x="Simulation Water Year", y="Annual Precip (mm/yr)")
```

This figures shows a Monte Carlo simulation of the annual precipitation generator comparing mean/sd/skew of the simulated (boxes) and historical (blue point) timeseries.

```{r plot-annual-mc}
# batch simulation to compare mean/sd/skew
z <- lapply(1:50, function(i) { 
    sim_annual_arima(x = obs[['wyr']][['PRCP']], start_year = start_water_year, n_year = n_year)[['out']]
  }) 
names(z) <- paste0(seq(1, length(z)))

do.call(merge, z) %>% 
  apply(MARGIN=2, FUN=function(x) { c(mean=mean(x), sd=sd(x), skew=skewness(x))}) %>% 
  t %>% 
  as.data.frame %>% 
  mutate(trial=row_number()) %>% 
  gather(stat, value, mean:skew) %>% 
  ggplot(aes(x=stat, value)) + 
  geom_boxplot() + 
  geom_point(aes(x=1, y=value), 
             data=data.frame(stat=c('mean', 'sd', 'skew'), 
                             value=c(mean(obs[['wyr']][['PRCP']]), sd(obs[['wyr']][['PRCP']]), skewness(obs[['wyr']][['PRCP']]))), 
             size=4, color='deepskyblue') +
  labs(x='', y='') +
  facet_wrap(~stat, scales='free')
```

## Daily Precipitation Simulation

The annual precipitation generated in the previous step is then used to drive a daily simulation. For each year, a k-nearest neighbors algorithm is used to sample `n_knn_annual` years from the historical record with replacement. A Markov Chain model is then fitted to the sampled historical years and used to simulate a sequence of states for each simulation year. Finally, the simulated states are used to sample the historical daily values using a daily KNN algorithm.

```{r sim-day}
sim_da <- sim_daily_from_annual(prcp_yr = sim_annual_prcp[['out']],
                                obs_da = zoo(x = obs[['day']][, c('PRCP', 'TEMP', 'TMIN', 'TMAX', 'WIND')], 
                                             order.by = obs[['day']][['DATE']]),
                                obs_prcp_yr = zoo(x = obs[['wyr']][['PRCP']], order.by = obs[['wyr']][['WYEAR']]),
                                start_month = start_month, n_knn_annual = n_knn_annual, 
                                dry_wet_threshold = 0.3, wet_extreme_quantile_threshold = 0.8)
```

```{r plot-sim-day}
select(sim_da[['out']], DATE, PRCP, TEMP, TMIN, TMAX) %>%
  gather(VAR, VALUE, PRCP:TMAX) %>%
  ggplot(aes(DATE, VALUE)) +
  geom_line() +
  facet_wrap(~VAR, scales='free_y') +
  labs(x='', y='')
```

Adjust daily simulated precipitation to match annual simulated precipitation.

```{r adj-sim-day}
sim_da_unadj <- select(sim_da[['out']], DATE, PRCP)
annual_sum_adjustment <- adjust_daily_to_annual(values_day=sim_da[['out']][['PRCP']], 
                                                years_day=wyear(sim_da[['out']][['DATE']], start_month = start_month), 
                                                values_yr=coredata(sim_annual_prcp[['out']]), 
                                                years_yr=time(sim_annual_prcp[['out']]), 
                                                min_ratio=0.9, max_ratio=1.1)
sim_da[['out']][, 'PRCP'] <- annual_sum_adjustment$adjusted
```

Compare the annual precip sum

```{r plot-sim-day-yr-adj}
mutate(sim_da_unadj, WYEAR=wyear(DATE, start_month=start_month)) %>%
  group_by(WYEAR) %>%
  summarise(PRCP=sum(PRCP)) %>%
  mutate(SOURCE="Orig Day") %>%
  rbind(data.frame(WYEAR=time(sim_annual_prcp[['out']]),
                   PRCP=coredata(sim_annual_prcp[['out']]),
                   SOURCE="Orig Wyr")) %>%
  rbind(mutate(sim_da[['out']], WYEAR=wyear(DATE, start_month=start_month)) %>%
          group_by(WYEAR) %>%
          summarise(PRCP=sum(PRCP)) %>%
          mutate(SOURCE="Adj Day")) %>%
  ggplot(aes(WYEAR, PRCP, color=SOURCE)) +
  geom_line()
```

```{r adj-sim-day-changes}
# TODO: compute mean_change from transition matrices
gamma_adjustment <- adjust_daily_gamma(sim_da[['out']][['PRCP']], sim_da[['out']][['MONTH']], mean_change=prcp_mean_changes, cv_change=prcp_cv_changes)
sim_da[['out']][, 'PRCP'] <- gamma_adjustment$adjusted

tmin_adjustment <- adjust_daily_additive(x = sim_da[['out']][['TMIN']], 
                                         months = sim_da[['out']][['MONTH']], 
                                         changes = temp_changes)
tmax_adjustment <- adjust_daily_additive(x = sim_da[['out']][['TMAX']], 
                                         months = sim_da[['out']][['MONTH']], 
                                         changes = temp_changes)
temp_adjustment <- adjust_daily_additive(x = sim_da[['out']][['TEMP']], 
                                         months = sim_da[['out']][['MONTH']], 
                                         changes = temp_changes)
sim_da[['out']][, 'TMIN'] <- tmin_adjustment$adjusted
sim_da[['out']][, 'TMAX'] <- tmax_adjustment$adjusted
sim_da[['out']][, 'TEMP'] <- temp_adjustment$adjusted
```

```{r plot-final-daily-results, fig.width=8, fig.height=6}
select(sim_da[['out']], DATE, PRCP, TEMP, TMIN, TMAX) %>%
  gather(VAR, VALUE, PRCP:TMAX) %>%
  ggplot(aes(DATE, VALUE)) +
  geom_line() +
  facet_wrap(~VAR, scales='free_y') +
  labs(x='', y='')
```

